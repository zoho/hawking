name: publish-package

on:
  release:
    types: [created]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version
        id: vars
        run: echo "tag=${GITHUB_REF#refs/*/}" >> $GITHUB_OUTPUT

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Debug info
        run: |
          echo "GITHUB_REF=$GITHUB_REF"
          echo "TAG=${{ steps.vars.outputs.tag }}"
          java -version || true
          mvn -version || true

      - name: Set up JDK 1.8
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '8'
          server-id: deployment
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE
      - name: Verify GPG import
        run: gpg --list-secret-keys || echo "No keys found"
      - name: Verify GPG key import
        run: |
          echo "Checking for imported GPG keys..."
          if gpg --list-secret-keys --keyid-format LONG; then
            echo "GPG key imported successfully."
          else
            echo " No GPG keys found â€” import failed."
            exit 1
          fi

      - name: Publish to the Maven Central Repository
        run: mvn --batch-mode clean deploy -DskipTests -DretryFailedDeploymentCount=3
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: target/hawking-${{ steps.vars.outputs.tag }}.jar
          asset_name: hawking-${{ steps.vars.outputs.tag }}.jar
          tag: ${{ github.ref }}
          overwrite: true

      - name: Publish summary
        if: ${{ success() }}
        run: echo "Successfully published Hawking-${{ steps.vars.outputs.tag }} to Maven Central and uploaded to GitHub Release."

      - name: Failure summary
        if: ${{ failure() }}
        run: |
          echo "Publishing failed. Please check:"
          echo "- GPG key and passphrase validity"
          echo "- OSSRH_USERNAME / OSSRH_TOKEN secrets"
          echo "- Correct <distributionManagement> section in pom.xml"
          echo "- JAR generated at target/hawking-${{ steps.vars.outputs.tag }}.jar"
